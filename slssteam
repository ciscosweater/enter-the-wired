#!/bin/bash
set -euo pipefail

# SLSsteam Installation Script
# Part of Enter The Wired project

# =============================================================================
# CONFIGURATION
# =============================================================================

# Colors (disabled if not interactive terminal)
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN='' RED='' YELLOW='' NC=''
fi

# =============================================================================
# SYSTEM DETECTION
# =============================================================================

is_bazzite() {
    [ -f /etc/os-release ] && source /etc/os-release && [ "${ID:-}" = "bazzite" ]
}

is_steam_deck() {
    [ -f /etc/os-release ] && source /etc/os-release
    [[ "${ID:-}" == "steamos" ]] || [[ "${VARIANT_ID:-}" == "steamdeck" ]]
}

# =============================================================================
# STEAM DETECTION
# =============================================================================

get_sls_install_dir() {
    echo "$HOME/.local/share/SLSsteam"
}

get_sls_config_dir() {
    echo "$HOME/.config/SLSsteam"
}

find_steam_directory() {
    local steam_paths=(
        "$HOME/.steam/steam"
        "$HOME/.local/share/Steam"
        "/opt/steam/steam"
        "/usr/local/steam"
    )

    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ] && [ -f "$path/steam.sh" ]; then
            echo "$path"
            return 0
        fi
    done

    for path in "${steam_paths[@]}"; do
        [ -d "$path" ] && echo "$path" && return 0
    done

    return 1
}

find_steam_executable() {
    # Bazzite/Steam Deck: skip /usr/bin/steam (read-only)
    if ! is_bazzite && ! is_steam_deck && [ -f "/usr/bin/steam" ]; then
        echo "/usr/bin/steam"
        return 0
    fi

    if command -v steam &>/dev/null; then
        local steam_path
        steam_path=$(command -v steam)
        # On Bazzite/Steam Deck, prefer wrapper over /usr/bin/steam
        if ! is_bazzite && ! is_steam_deck; then
            echo "$steam_path"
            return 0
        elif [ "$steam_path" != "/usr/bin/steam" ]; then
            echo "$steam_path"
            return 0
        fi
    fi

    for path in /usr/local/bin/steam "$HOME/.local/bin/steam"; do
        [ -f "$path" ] && [ -x "$path" ] && echo "$path" && return 0
    done

    # Fallback for Bazzite/Steam Deck
    if [ -f "/usr/bin/steam" ] && [ -x "/usr/bin/steam" ]; then
        echo "/usr/bin/steam"
        return 0
    fi

    return 1
}

# =============================================================================
# STEAM MANAGEMENT
# =============================================================================

close_steam_graceful() {
    local steam_exe
    steam_exe=$(find_steam_executable 2>/dev/null) || {
        echo "  Warning: Steam executable not found"
        return 1
    }

    echo "  Closing Steam gracefully via steam://exit..."
    timeout 30 $steam_exe -clearbeta steam://exit 2>/dev/null || true
}

close_steam() {
    local steam_pids

    if close_steam_graceful; then
        sleep 3
        steam_pids=$(pgrep -x "steam" 2>/dev/null || true)
        if [ -z "$steam_pids" ]; then
            echo "  Steam closed gracefully"
            return 0
        fi
        echo "  Steam still running, force closing..."
    fi

    steam_pids=$(pgrep -x "steam" 2>/dev/null || true)
    if [ -n "$steam_pids" ]; then
        echo "  Force closing Steam..."
        echo "$steam_pids" | xargs kill 2>/dev/null || true
        sleep 2
    fi

    steam_pids=$(pgrep -x "steam" 2>/dev/null || true)
    [ -z "$steam_pids" ]
}

run_steam_with_sls() {
    local steam_exe

    steam_exe=$(find_steam_executable) || {
        echo "  Warning: Steam executable not found, cannot run Steam"
        return 1
    }

    LD_AUDIT=$HOME/.local/share/SLSsteam/library-inject.so:$HOME/.local/share/SLSsteam/SLSsteam.so $steam_exe "$@"
}

# =============================================================================
# PATCHING
# =============================================================================

patch_steam_sh() {
    local steam_sh="$HOME/.steam/steam/steam.sh"
    [ -f "$steam_sh" ] || steam_sh="$HOME/.local/share/Steam/steam.sh"
    [ -f "$steam_sh" ] || return 0

    if grep -q "LD_AUDIT.*SLSsteam" "$steam_sh" 2>/dev/null; then
        echo "  steam.sh already patched, updating..."
        sed -i '/^export LD_AUDIT.*SLSsteam/d' "$steam_sh"
    fi

    sed -i '10a export LD_AUDIT=$HOME/.local/share/SLSsteam/library-inject.so:$HOME/.local/share/SLSsteam/SLSsteam.so' "$steam_sh"
    echo "  Patched steam.sh at $steam_sh"
}

# Steam Deck only: patch steam-jupiter for Gaming Mode
patch_steam_jupiter() {
    local -r steam_jupiter="/usr/bin/steam-jupiter"

    [ -f "$steam_jupiter" ] || {
        echo "  steam-jupiter not found"
        return 1
    }

    echo "  Patching steam-jupiter at $steam_jupiter..."

    if [ ! -f "${steam_jupiter}.bak" ]; then
        sudo cp "$steam_jupiter" "${steam_jupiter}.bak"
        echo "  Backup created: ${steam_jupiter}.bak"
    fi

    if grep -q "LD_AUDIT.*SLSsteam" "$steam_jupiter" 2>/dev/null; then
        echo "  steam-jupiter already patched, updating..."
        sudo sed -i '/^export LD_AUDIT.*SLSsteam/d' "$steam_jupiter"
    fi

    if grep -q 'exec /usr/lib/steam/steam -steamdeck' "$steam_jupiter" 2>/dev/null; then
        sudo sed -i '/^exec \/usr\/lib\/steam\/steam -steamdeck/i export LD_AUDIT=$HOME/.local/share/SLSsteam/library-inject.so:$HOME/.local/share/SLSsteam/SLSsteam.so' "$steam_jupiter"
        echo "  Patched steam-jupiter with LD_AUDIT"
    else
        sudo sed -i '/^exec.*steam.*"-steamdeck"/i export LD_AUDIT=$HOME/.local/share/SLSsteam/library-inject.so:$HOME/.local/share/SLSsteam/SLSsteam.so' "$steam_jupiter" 2>/dev/null || \
        sudo sed -i '/^exec.*steam/i export LD_AUDIT=$HOME/.local/share/SLSsteam/library-inject.so:$HOME/.local/share/SLSsteam/SLSsteam.so' "$steam_jupiter" 2>/dev/null || true
        echo "  Applied fallback patch to steam-jupiter"
    fi
}

# Bazzite only: patch desktop files to use wrapper
patch_steam_desktop() {
    local autostart_file="$HOME/.config/autostart/steam.desktop"
    local system_autostart="/etc/xdg/autostart/steam.desktop"
    local desktop_shortcut="$HOME/.local/share/applications/steam.desktop"

    # Copy autostart from system if it doesn't exist
    if [[ ! -f "$autostart_file" ]] && [[ -f "$system_autostart" ]]; then
        echo "  Copying autostart file from $system_autostart..."
        mkdir -p "$HOME/.config/autostart"
        cp "$system_autostart" "$autostart_file"
    fi

    # Patch autostart
    if [[ -f "$autostart_file" ]]; then
        if grep -q "Exec=bazzite-steam" "$autostart_file" 2>/dev/null; then
            echo "  Autostart already uses bazzite-steam"
        else
            echo "  Patching autostart to use bazzite-steam..."
            sed -i 's|Exec=/usr/bin/bazzite-steam[^ ]*|Exec=bazzite-steam|g' "$autostart_file"
        fi
    fi

    # Patch desktop shortcut
    if [[ -f "$desktop_shortcut" ]]; then
        if grep -q "Exec=bazzite-steam" "$desktop_shortcut" 2>/dev/null; then
            echo "  Desktop shortcut already uses bazzite-steam"
        else
            echo "  Patching desktop shortcut to use bazzite-steam..."
            sed -i 's|Exec=/usr/bin/bazzite-steam[^ ]*|Exec=bazzite-steam|g' "$desktop_shortcut"
        fi
    fi
}

# =============================================================================
# CLEANUP
# =============================================================================

cleanup_ld_audit() {
    echo "Cleaning up existing LD_AUDIT patches..."

    # Clean steam.sh
    for steam_sh in "$HOME/.steam/steam/steam.sh" "$HOME/.local/share/Steam/steam.sh"; do
        if [ -f "$steam_sh" ]; then
            if grep -q "LD_AUDIT.*SLSsteam" "$steam_sh" 2>/dev/null; then
                sed -i '/export LD_AUDIT.*SLSsteam/d' "$steam_sh"
                echo "  Cleaned: $steam_sh"
            fi
        fi
    done

    # Clean steam-jupiter (Steam Deck)
    local steam_jupiter="/usr/bin/steam-jupiter"
    if [ -f "$steam_jupiter" ]; then
        if grep -q "LD_AUDIT.*SLSsteam" "$steam_jupiter" 2>/dev/null; then
            sudo sed -i '/export LD_AUDIT.*SLSsteam/d' "$steam_jupiter"
            echo "  Cleaned: $steam_jupiter"
        fi
    fi

    # Remove wrappers
    for wrapper in "/usr/local/bin/steam" "/usr/local/bin/bazzite-steam"; do
        if [ -f "$wrapper" ]; then
            sudo rm -f "$wrapper"
            echo "  Removed: $wrapper"
        fi
    done

    # Remove backups
    if [ -f "/usr/bin/steam-jupiter.bak" ]; then
        sudo rm -f "/usr/bin/steam-jupiter.bak"
        echo "  Removed backup: /usr/bin/steam-jupiter.bak"
    fi

    echo "Cleanup complete!"
}

# =============================================================================
# WRAPPERS (Bazzite only)
# =============================================================================

create_steam_wrapper() {
    if [ ! -d "/usr/local/bin" ]; then
        echo "  Creating /usr/local/bin directory..."
        sudo mkdir -p /usr/local/bin
    fi

    # Game Mode wrapper
    echo "  Creating steam wrapper for Game Mode..."
    sudo tee "/usr/local/bin/steam" > /dev/null << EOF
#!/usr/bin/env bash
export LD_AUDIT=$HOME/.local/share/SLSsteam/library-inject.so:$HOME/.local/share/SLSsteam/SLSsteam.so
exec /usr/bin/steam "\$@"
EOF
    sudo chmod +x "/usr/local/bin/steam"
    echo "  Wrapper created: /usr/local/bin/steam"

    # Desktop Mode wrapper
    echo "  Creating bazzite-steam wrapper for Desktop Mode..."
    sudo tee "/usr/local/bin/bazzite-steam" > /dev/null << EOF
#!/usr/bin/env bash
export LD_AUDIT=$HOME/.local/share/SLSsteam/library-inject.so:$HOME/.local/share/SLSsteam/SLSsteam.so
exec /usr/bin/bazzite-steam "\$@"
EOF
    sudo chmod +x "/usr/local/bin/bazzite-steam"
    echo "  Wrapper created: /usr/local/bin/bazzite-steam"
}

# =============================================================================
# INJECTION CONFIGURATION
# =============================================================================

configure_slssteam_injection() {
    local sls_dir sls_config config_file
    sls_dir=$(get_sls_install_dir)
    sls_config=$(get_sls_config_dir)
    config_file="$sls_config/config.yaml"

    # Enable PlayNotOwnedGames for all systems
    if [ -f "$config_file" ]; then
        if grep -q -F "PlayNotOwnedGames: no" "$config_file" 2>/dev/null; then
            sed -i 's/PlayNotOwnedGames: no/PlayNotOwnedGames: yes/' "$config_file"
        elif ! grep -q -F "PlayNotOwnedGames: yes" "$config_file" 2>/dev/null; then
            echo "PlayNotOwnedGames: yes" >> "$config_file"
        fi
        echo "  PlayNotOwnedGames enabled"
    fi

    # Steam Deck: patch steam-jupiter, enable SafeMode
    if is_steam_deck; then
        echo "  Steam Deck detected"

        if [ -f "/usr/bin/steam-jupiter" ]; then
            echo ""
            echo -e "${GREEN}Patching steam-jupiter for Gaming Mode...${NC}"
            patch_steam_jupiter
        else
            echo -e "${YELLOW}Warning: steam-jupiter not found${NC}"
        fi

        # Enable SafeMode on Steam Deck
        if [ -f "$config_file" ]; then
            if grep -q "^SafeMode:" "$config_file" 2>/dev/null; then
                sed -i 's/^SafeMode:.*/SafeMode: yes/' "$config_file"
            else
                echo "SafeMode: yes" >> "$config_file"
            fi
            echo "  SafeMode enabled"
        fi
        return 0
    fi

    # Bazzite: create wrappers at /usr/local/bin
    if is_bazzite; then
        echo "  Bazzite detected"
        echo ""
        echo -e "${GREEN}Creating Steam wrappers...${NC}"
        create_steam_wrapper
        echo ""
        echo -e "${GREEN}Patching desktop/autorun files...${NC}"
        patch_steam_desktop
        return 0
    fi

    # Standard Linux: nothing to do (setup.sh already ran during install)
    return 0
}

# =============================================================================
# FINALIZATION
# =============================================================================

finalize_steam() {
    local steam_dir steam_cfg
    steam_dir=$(find_steam_directory) || steam_dir="$HOME/.steam/steam"
    steam_cfg="$steam_dir/steam.cfg"

    echo "Finalizing Steam configuration..."

    [ -f "$steam_cfg" ] && rm -f "$steam_cfg" && echo "  Removed steam.cfg"

    if close_steam_graceful; then
        echo "  Steam will close and update via steam://exit"
    elif is_steam_deck; then
        echo "  Steam Deck detected - will patch steam-jupiter for Gaming Mode"
    else
        echo "  Steam not found, opening to check for updates..."
        if command -v steam &>/dev/null; then
            run_steam_with_sls &
            local run_steam_pid=$!
            sleep 5

            local attempts=0
            while [ $attempts -lt 12 ]; do
                pgrep -x "steam" &>/dev/null && break
                sleep 1
                attempts=$((attempts + 1))
            done

            sleep 30
            close_steam
            kill $run_steam_pid 2>/dev/null || true
        fi
    fi

    cat > "$steam_cfg" << 'EOF'
BootStrapperInhibitAll=enable
BootStrapperForceSelfUpdate=disable
EOF
    echo "  Created steam.cfg"
}

# =============================================================================
# MAIN INSTALLATION
# =============================================================================

install_slssteam() {
    echo -e "${GREEN}Installing SLSsteam...${NC}"
    echo ""

    # Clean up any existing LD_AUDIT patches before installing
    cleanup_ld_audit

    local slssteam_install_dir slssteam_config_dir steam_dir
    slssteam_install_dir=$(get_sls_install_dir)
    slssteam_config_dir=$(get_sls_config_dir)

    # Check if Steam is installed
    steam_dir=$(find_steam_directory) || {
        echo -e "${YELLOW}Warning: Steam directory not found${NC}"
        echo "SLSsteam installation will be skipped."
        echo "Install Steam and re-run this script to enable SLSsteam."
        return 0
    }

    # Check if Steam is running
    local steam_pid
    steam_pid=$(pgrep -x "steam" 2>/dev/null || true)
    if [ -n "$steam_pid" ]; then
        echo -e "${RED}Error: Steam is currently running${NC}"
        echo ""
        echo "Please close Steam completely before running this script."
        echo "After closing Steam, run this script again."
        echo ""
        exit 1
    fi

    # Create directories
    mkdir -p "$slssteam_install_dir" "$slssteam_config_dir"

    # Backup existing config
    if [ -f "$slssteam_config_dir/config.yaml" ]; then
        cp "$slssteam_config_dir/config.yaml" "$slssteam_config_dir/config.yaml.bak"
        echo "Config backup created."
    fi

    # Download
    echo "Downloading SLSsteam..."
    local release_json temp_sls="/tmp/slssteam.7z"
    release_json=$(curl -s "https://api.github.com/repos/AceSLS/SLSsteam/releases/latest")

    if [ -z "$release_json" ] || echo "$release_json" | grep -q '"message":'; then
        echo -e "${RED}Error fetching SLSsteam release info.${NC}"
        return 1
    fi

    local latest_url
    latest_url=$(echo "$release_json" | grep -o '"browser_download_url": *"[^\"]*SLSsteam-Any\.7z"' | \
                 sed 's/"browser_download_url": *"\([^\"]*\)"/\1/' | head -1)

    if [ -z "$latest_url" ]; then
        echo -e "${RED}Error: Could not find SLSsteam-Any.7z in release assets.${NC}"
        return 1
    fi

    if ! curl -sL -o "$temp_sls" "$latest_url"; then
        echo -e "${RED}Error downloading SLSsteam.${NC}"
        rm -f "$temp_sls"
        return 1
    fi

    # Extraction
    echo "Extracting SLSsteam..."
    rm -rf /tmp/slssteam_extract
    mkdir -p /tmp/slssteam_extract

    if ! 7z x "$temp_sls" -o/tmp/slssteam_extract -y 2>&1 | tail -5; then
        echo -e "${RED}Error extracting archive.${NC}"
        rm -rf /tmp/slssteam_extract "$temp_sls"
        return 1
    fi

    local slssteam_so
    slssteam_so=$(find /tmp/slssteam_extract -name "SLSsteam.so" -type f 2>/dev/null | head -1)

    if [ -z "$slssteam_so" ]; then
        echo -e "${RED}Error: SLSsteam.so not found in archive.${NC}"
        rm -rf /tmp/slssteam_extract "$temp_sls"
        return 1
    fi

    echo "Found SLSsteam.so at: $slssteam_so"

    # Copy config if it doesn't exist
    if [ ! -f "$slssteam_config_dir/config.yaml" ] && [ -f "/tmp/slssteam_extract/res/config.yaml" ]; then
        cp /tmp/slssteam_extract/res/config.yaml "$slssteam_config_dir/config.yaml"
    fi

    # Installation
    cd /tmp/slssteam_extract
    if [ -f "setup.sh" ]; then
        ./setup.sh install
    else
        echo "setup.sh not found, falling back to manual install..."
        cp "$slssteam_so" "$slssteam_install_dir/"
    fi

    cd ~ 2>/dev/null || cd / 2>/dev/null || true
    rm -rf /tmp/slssteam_extract "$temp_sls"

    # Finalization
    echo ""
    echo -e "${GREEN}Finalizing Steam configuration...${NC}"
    finalize_steam

    # Configure injection based on system type
    echo ""
    echo -e "${GREEN}Configuring SLSsteam injection...${NC}"
    configure_slssteam_injection

    # Patch steam.sh if it exists (all systems except Bazzite)
    if ! is_bazzite && ([ -f "$HOME/.steam/steam/steam.sh" ] || [ -f "$HOME/.local/share/Steam/steam.sh" ]); then
        echo ""
        echo -e "${GREEN}Patching steam.sh...${NC}"
        patch_steam_sh
    fi

    echo ""
    echo "SLSsteam installed and configured successfully!"
    echo "Just open Steam normally to play."
}

install_slssteam "$@"
