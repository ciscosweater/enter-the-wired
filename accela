#!/bin/bash
set -euo pipefail

# ACCELA Installation Script
# Part of Enter The Wired project

# Colors (disabled if not interactive terminal)
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN=''
    RED=''
    YELLOW=''
    NC=''
fi

# Configuration
GITHUB_REPO="ciscosweater/enter-the-wired"
INSTALL_DIR="$HOME/accela"

# Check if running on SteamOS (uses AppImage)
is_steamos() {
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        [[ "$ID" == "steamos" ]] && return 0
    fi
    return 1
}

# Check if running on Bazzite (uses binary)
is_bazzite() {
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        [[ "$ID" == "bazzite" ]] && return 0
    fi
    return 1
}

is_void() {
    [ -f /etc/os-release ] && source /etc/os-release && [ "${ID:-}" = "void"]
}

# Fetch latest ACCELA release from GitHub API
get_latest_release() {
    local asset_type="$1"
    local release_info

    echo "Fetching latest ACCELA release info..." >&2

    # Fetch release data from GitHub API
    release_info=$(curl -sSL "https://api.github.com/repos/$GITHUB_REPO/releases/latest")

    if [ -z "$release_info" ] || echo "$release_info" | grep -q '"message":'; then
        echo -e "${RED}Error fetching release info from GitHub API${NC}"
        return 1
    fi

    # Parse the download URL based on asset type
    case "$asset_type" in
        source)
            echo "$release_info" | grep -o '"browser_download_url": *"[^"]*ACCELA-[^"]*-linux-source\.tar\.gz"' | head -1 | sed 's/"browser_download_url": *"\(.*\)"/\1/'
            ;;
        appimage)
            echo "$release_info" | grep -o '"browser_download_url": *"[^"]*ACCELA-[^"]*-linux-appimage\.tar\.gz"' | head -1 | sed 's/"browser_download_url": *"\(.*\)"/\1/'
            ;;
        binary)
            echo "$release_info" | grep -o '"browser_download_url": *"[^"]*ACCELA-[^"]*-linux-binary\.tar\.gz"' | head -1 | sed 's/"browser_download_url": *"\(.*\)"/\1/'
            ;;
        *)
            echo ""
            return 1
            ;;
    esac
}

# Install ACCELA
install_accela() {
    echo -e "${GREEN}Installing ACCELA...${NC}"
    echo ""

    # Load os-release for ID detection
    if [ -f /etc/os-release ]; then
        source /etc/os-release
    fi

    # Install .NET SDK 9.0
    echo -e "${GREEN}Installing .NET SDK 9.0...${NC}"
    if ! curl -sSL https://dot.net/v1/dotnet-install.sh | bash -s -- --channel 9.0 --runtime dotnet 2>&1; then
        echo -e "${YELLOW}Warning: .NET SDK installation failed. Continuing anyway...${NC}"
    fi

    export PATH="$HOME/.dotnet:$PATH"

    # Choose URL based on distribution
    local TEMP_ARCHIVE
    local ACCELA_URL
    local LOCAL_ARCHIVE

    # Cleanup to avoid conflicts with previous installation attempts
    rm -rf ACCELA-*-linux-source ACCELA-*-linux-appimage ACCELA-*-linux-binary 2>/dev/null || true

    if is_bazzite; then
        echo "Fetching latest binary release for Bazzite..."
        ACCELA_URL=$(get_latest_release "binary")
        TEMP_ARCHIVE="accela_binary.tar.gz"
        echo "Using binary for Bazzite..."
    elif is_steamos; then
        echo "Fetching latest AppImage release for SteamOS..."
        ACCELA_URL=$(get_latest_release "appimage")
        TEMP_ARCHIVE="accela_appimage.tar.gz"
        echo "Using AppImage for SteamOS..."
    else
        echo "Fetching latest source release..."
        ACCELA_URL=$(get_latest_release "source")
        TEMP_ARCHIVE="accela_source.tar.gz"
        echo "Using source build..."
    fi

    if [ -z "$ACCELA_URL" ]; then
        echo -e "${RED}Error: Could not find download URL for ACCELA${NC}"
        return 1
    fi

    # Procurar por ACCELA*.tar.gz no diretÃ³rio atual
    LOCAL_ARCHIVE=$(find . -maxdepth 1 -name "ACCELA*.tar.gz" -type f 2>/dev/null | head -1 || true)

    if [ -n "$LOCAL_ARCHIVE" ]; then
        echo "Found local archive: $LOCAL_ARCHIVE"
        TEMP_ARCHIVE="$LOCAL_ARCHIVE"
    else
        echo "Downloading ACCELA..."
        if ! curl -L -o "$TEMP_ARCHIVE" "$ACCELA_URL"; then
            echo -e "${RED}Download error. Check URL or connection.${NC}"
            rm -f "$TEMP_ARCHIVE" 2>/dev/null
            return 1
        fi
    fi

    # Verify download was successful (minimum 1KB)
    if [ ! -f "$TEMP_ARCHIVE" ]; then
        echo -e "${RED}Error: Download failed or file is empty.${NC}"
        rm -f "$TEMP_ARCHIVE" 2>/dev/null
        return 1
    fi

    local FILE_SIZE=$(stat -c%s "$TEMP_ARCHIVE" 2>/dev/null || stat -f%z "$TEMP_ARCHIVE" 2>/dev/null || echo 0)
    if [ "$FILE_SIZE" -lt 1024 ]; then
        echo -e "${RED}Error: Downloaded file is too small (corrupted).${NC}"
        rm -f "$TEMP_ARCHIVE" 2>/dev/null
        return 1
    fi

    mkdir -p "$INSTALL_DIR"

    # Clean up any previous installation in INSTALL_DIR
    rm -rf "$INSTALL_DIR"/*

    echo "Extracting archive..."
    if ! tar -xzf "$TEMP_ARCHIVE" -C "$INSTALL_DIR"; then
        echo -e "${RED}Error extracting archive. Download may be corrupted.${NC}"
        rm -f "$TEMP_ARCHIVE" 2>/dev/null
        return 1
    fi
    rm "$TEMP_ARCHIVE"

    if ! cd "$INSTALL_DIR"; then
        echo -e "${RED}Error: Could not access $INSTALL_DIR${NC}"
        return 1
    fi

    echo "Making installer executable..."
    if [ -f "./ACCELAINSTALL" ]; then
        chmod +x ./ACCELAINSTALL

        echo -e "${GREEN}Running ACCELAINSTALL...${NC}"
        export SKIPVENV="${SKIPVENV:-0}"
        if ! ./ACCELAINSTALL; then
            echo -e "${RED}Error running ACCELAINSTALL.${NC}"
            return 1
        fi
    else
        echo -e "${RED}Error: 'ACCELAINSTALL' not found in extracted folder.${NC}"
        ls -la
        return 1
    fi

    # Clean up installer directory
    echo "Cleaning up temporary files..."
    rm -rf "$INSTALL_DIR"

    echo -e "${GREEN}ACCELA installed successfully!${NC}"
}

install_accela "$@"
