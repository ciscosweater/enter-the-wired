#!/bin/bash
### disabled set -e so the script keeps going even if a file is missing
set -uo pipefail

# Colors (disabled if not interactive terminal)
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN=''
    RED=''
    YELLOW=''
    NC=''
fi

# Function to find Steam executable (handles native, Flatpak, custom paths)
find_steam_executable() {
    # 1. Use standard Steam path
    if [ -f "/usr/bin/steam" ]; then
        echo "/usr/bin/steam"
        return 0
    fi

    # 2. Check if Flatpak Steam is available
    if command -v flatpak &>/dev/null; then
        if flatpak info com.valvesoftware.Steam &>/dev/null 2>&1; then
            echo "flatpak run com.valvesoftware.Steam"
            return 0
        fi
    fi

    # 3. Check PATH for steam command (fallback)
    if command -v steam &>/dev/null; then
        echo "$(command -v steam)"
        return 0
    fi

    # 4. Check alternative paths
    for path in /usr/local/bin/steam "$HOME/.local/bin/steam"; do
        if [ -f "$path" ] && [ -x "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# Function to find Steam directory
find_steam_directory() {
    # Common Steam installation paths (in order of preference)
    local steam_paths=(
        "$HOME/.steam/steam"                    # Modern Steam
        "$HOME/.local/share/Steam"              # Traditional location
        "$FLATPAK_STEAM_DIR"                    # Flatpak Steam
        "/opt/steam/steam"                      # Custom /opt
        "/usr/local/steam"                      # Custom /usr/local
    )

    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ] && [ -f "$path/steam.sh" ]; then
            echo "$path"
            return 0
        fi
    done

    # Fallback: check for any existing directory
    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# This script uninstalls ACCELA and SLSsteam from the user's home directory, providing a clear restart for updates and fixes.

# Check if running on Bazzite
is_bazzite() {
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        [[ "${ID:-}" == "bazzite" ]] && return 0
    fi
    return 1
}

# --- Cleanup LD_AUDIT patches and wrappers ---
cleanup_ld_audit() {
    ### use yellow for warning as requested
    echo -e "${YELLOW}[WARNING] Cleaning up LD_AUDIT patches...${NC}"

    # Clean steam.sh (all possible locations)
    for steam_sh in \
        "$HOME/.steam/steam/steam.sh" \
        "$HOME/.local/share/Steam/steam.sh" \
        "/var/home/$USER/.steam/steam/steam.sh" \
        "/var/home/$USER/.local/share/Steam/steam.sh" \
        "/usr/share/steam/steam.sh"; do
        if [ -f "$steam_sh" ]; then
            if grep -q "LD_AUDIT.*SLSsteam" "$steam_sh" 2>/dev/null; then
                ### use sudo as fallback if file is locked
                sudo sed -i '/export LD_AUDIT.*SLSsteam/d' "$steam_sh" 2>/dev/null || sed -i '/export LD_AUDIT.*SLSsteam/d' "$steam_sh"
                echo "  Cleaned: $steam_sh"
            fi
        fi
    done

    # Clean steam-jupiter (Steam Deck)
    local steam_jupiter="/usr/bin/steam-jupiter"
    if [ -f "$steam_jupiter" ]; then
        if grep -q "LD_AUDIT.*SLSsteam" "$steam_jupiter" 2>/dev/null; then
            sudo sed -i '/export LD_AUDIT.*SLSsteam/d' "$steam_jupiter"
            echo "  Cleaned: $steam_jupiter"
        fi
    fi

    # Remove wrappers
    for wrapper in "/usr/local/bin/steam" "/usr/local/bin/bazzite-steam"; do
        if [ -f "$wrapper" ]; then
            sudo rm -f "$wrapper"
            echo "  Removed: $wrapper"
        fi
    done

    # Remove backups
    if [ -f "/usr/bin/steam-jupiter.bak" ]; then
        sudo rm -f "/usr/bin/steam-jupiter.bak"
        echo "  Removed backup: /usr/bin/steam-jupiter.bak"
    fi

    ### simple green done message
    echo -e "${GREEN}[DONE] Cleanup complete!${NC}"
}

# --- Cleanup SLSsteam configuration and desktop files ---
cleanup_slssteam() {
    ### starting shortcut and config cleanup
    echo -e "${YELLOW}[WARNING] Cleaning up configuration and shortcuts...${NC}"

    local autostart_file="$HOME/.config/autostart/steam.desktop"

    ### forced removal of all annoying leftovers and localized desktops
    rm -f "$HOME/.local/share/applications/steam.desktop"
    rm -f "$HOME/.local/share/applications/accela.desktop"
    rm -f "$HOME/.local/share/applications/ACCELA.desktop"
    rm -f "$HOME/.local/share/accela.desktop"
    rm -f "$HOME/.local/bin/accela-update"
    rm -f "$HOME/.local/bin/accela"

    local desktop_folders=("$HOME/Desktop" "$HOME/Ãrea de Trabalho" "$(xdg-user-dir DESKTOP 2>/dev/null || echo "$HOME/Desktop")")
    for folder in "${desktop_folders[@]}"; do
        if [ -d "$folder" ]; then
            rm -f "$folder/steam.desktop" "$folder/accela.desktop" "$folder/ACCELA.desktop"
        fi
    done

    # Remove ACCELA and SLSsteam directories
    local dirs_to_remove=(
        "$HOME/.local/share/ACCELA"
        "$HOME/.local/share/SLSsteam"
        "$HOME/.config/SLSsteam"
        "$HOME/.var/app/com.valvesoftware.Steam/.local/share/SLSsteam"
        "$HOME/.var/app/com.valvesoftware.Steam/.config/SLSsteam"
    )

    for dir in "${dirs_to_remove[@]}"; do
        if [ -d "$dir" ]; then
            rm -rf "$dir"
            echo "  Removed: $dir"
        fi
    done

    # Remove steam.cfg (created by SLSsteam to block updates)
    local steam_cfg_dir=$(find_steam_directory 2>/dev/null || true)
    if [[ -n "$steam_cfg_dir" ]] && [[ -f "$steam_cfg_dir/steam.cfg" ]]; then
        rm -f "$steam_cfg_dir/steam.cfg"
        echo "  Removed steam.cfg"
    fi

    # Restore autostart to use correct Steam executable
    if [[ -f "$autostart_file" ]]; then
        if is_bazzite; then
            sed -i 's|Exec=[^ ]*steam[^ ]*|Exec=bazzite-steam|g' "$autostart_file"
        else
            sed -i 's|Exec=[^ ]*steam[^ ]*|Exec=/usr/bin/steam|g' "$autostart_file"
        fi
        echo "  Restored autostart executable."
    fi

    ### final done message for uninstallation
    echo -e "${GREEN}[DONE] Uninstallation completed!${NC}"
}

# Find steam.sh location for debugging
find_steam_sh() {
    for steam_sh in \
        "$HOME/.steam/steam/steam.sh" \
        "$HOME/.local/share/Steam/steam.sh" \
        "/var/home/$USER/.steam/steam/steam.sh" \
        "/var/home/$USER/.local/share/Steam/steam.sh" \
        "/usr/share/steam/steam.sh"; do
        if [ -f "$steam_sh" ]; then
            echo "$steam_sh"
            return 0
        fi
    done
    return 1
}

echo -e "${GREEN}Starting uninstallation...${NC}"
echo ""

# Debug: show steam.sh location
steam_sh_location=$(find_steam_sh 2>/dev/null || true)
if [ -n "$steam_sh_location" ]; then
    echo "Found steam.sh at: $steam_sh_location"
fi

# Execution
cleanup_ld_audit
cleanup_slssteam

echo ""
echo -e "${GREEN}Process finished. Reboot recommended.${NC}"
