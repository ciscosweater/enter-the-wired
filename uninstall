#!/bin/bash
set -euo pipefail

# Colors (disabled if not interactive terminal)
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN=''
    RED=''
    YELLOW=''
    NC=''
fi

# Function to find Steam executable (handles native, Flatpak, custom paths)
find_steam_executable() {
    # 1. Use standard Steam path
    if [ -f "/usr/bin/steam" ]; then
        echo "/usr/bin/steam"
        return 0
    fi

    # 2. Check if Flatpak Steam is available
    if command -v flatpak &>/dev/null; then
        if flatpak info com.valvesoftware.Steam &>/dev/null 2>&1; then
            echo "flatpak run com.valvesoftware.Steam"
            return 0
        fi
    fi

    # 3. Check PATH for steam command (fallback)
    if command -v steam &>/dev/null; then
        echo "$(command -v steam)"
        return 0
    fi

    # 4. Check alternative paths
    for path in /usr/local/bin/steam "$HOME/.local/bin/steam"; do
        if [ -f "$path" ] && [ -x "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# Function to find Steam directory
find_steam_directory() {
    # Common Steam installation paths (in order of preference)
    local steam_paths=(
        "$HOME/.steam/steam"                    # Modern Steam
        "$HOME/.local/share/Steam"              # Traditional location
        "$FLATPAK_STEAM_DIR"                    # Flatpak Steam
        "/opt/steam/steam"                      # Custom /opt
        "/usr/local/steam"                      # Custom /usr/local
    )

    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ] && [ -f "$path/steam.sh" ]; then
            echo "$path"
            return 0
        fi
    done

    # Fallback: check for any existing directory
    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# This script uninstalls ACCELA and SLSsteam from the user's home directory, providing a clear restart for updates and fixes.

# Check if running on Bazzite
is_bazzite() {
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        [[ "$ID" == "bazzite" ]] && return 0
    fi
    return 1
}

# --- Uninstall SLSsteam Injection ---
uninstall_slssteam_injection() {
    echo "Cleaning up SLSsteam injection..."

    local steam_script
    local steam_backup
    local desktop_shortcut="$HOME/.local/share/applications/steam.desktop"
    local autostart_file="$HOME/.config/autostart/steam.desktop"

    # Detect Bazzite
    local is_bazzite
    is_bazzite=$(is_bazzite && echo "1" || echo "0")

    # Steam Deck: Restore steam-jupiter from backup
    local steam_jupiter="/usr/bin/steam-jupiter"
    if [ -f "$steam_jupiter" ]; then
        echo "  Steam Deck detected - cleaning steam-jupiter..."
        local jupiter_backup="${steam_jupiter}.bak"
        if [[ -f "$jupiter_backup" ]]; then
            if sudo cp "$jupiter_backup" "$steam_jupiter"; then
                echo "    Restored original: $steam_jupiter"
                sudo rm -f "$jupiter_backup"
            else
                echo -e "    ${YELLOW}Warning: Failed to restore $steam_jupiter${NC}"
            fi
        else
            # Try to remove LD_AUDIT lines if present
            if grep -q "LD_AUDIT" "$steam_jupiter" 2>/dev/null; then
                if sudo sed -i '/^export LD_AUDIT/d' "$steam_jupiter"; then
                    echo "    Removed LD_AUDIT lines from $steam_jupiter"
                else
                    echo -e "    ${YELLOW}Warning: Failed to modify $steam_jupiter${NC}"
                fi
            fi
        fi
    fi

    # Try to find Steam executable
    if steam_script=$(find_steam_executable 2>/dev/null); then
        steam_backup="${steam_script}.bak"

        # Restore original steam script from backup
        if [[ -f "$steam_backup" ]]; then
            if sudo cp "$steam_backup" "$steam_script"; then
                echo "  Restored original: $steam_script"
                sudo rm -f "$steam_backup"
            else
                echo -e "  ${YELLOW}Warning: Failed to restore $steam_script${NC}"
            fi
        else
            # Try to remove LD_AUDIT lines if present
            if grep -q "LD_AUDIT" "$steam_script" 2>/dev/null; then
                if sudo sed -i '/^export LD_AUDIT/d' "$steam_script"; then
                    echo "  Removed LD_AUDIT lines from $steam_script"
                else
                    echo -e "  ${YELLOW}Warning: Failed to modify $steam_script${NC}"
                fi
            fi
        fi
    else
        echo -e "${YELLOW}  Warning: Steam executable not found, skipping script cleanup${NC}"
    fi

    # Remove desktop shortcut override (system shortcut will be used again)
    if [[ -f "$desktop_shortcut" ]]; then
        rm -f "$desktop_shortcut"
        echo "  Removed desktop shortcut override."
    fi

    # Restore autostart to use system steam
    if [[ -f "$autostart_file" ]]; then
        # Replace any Exec line pointing to steam with system path
        sed -i 's|Exec=[^ ]*steam[^ ]*|Exec=/usr/bin/steam|g' "$autostart_file"
        echo "  Restored autostart entry."
    fi

    # Also clean up any SLSsteam wrapper if it exists
    if [ $is_bazzite -eq 1 ]; then
        # On Bazzite: remove bazzite-steam and old steam wrapper
        if [[ -f "/usr/local/bin/bazzite-steam" ]]; then
            if sudo rm -f "/usr/local/bin/bazzite-steam"; then
                echo "  Removed bazzite-steam wrapper"
            else
                echo -e "  ${YELLOW}Warning: Failed to remove /usr/local/bin/bazzite-steam${NC}"
            fi
        fi
        if [[ -f "/usr/local/bin/steam" ]]; then
            if sudo rm -f "/usr/local/bin/steam"; then
                echo "  Removed old steam wrapper"
            else
                echo -e "  ${YELLOW}Warning: Failed to remove /usr/local/bin/steam${NC}"
            fi
        fi
    else
        # On other distros: only remove steam wrapper
        if [[ -f "/usr/local/bin/steam" ]]; then
            if sudo rm -f "/usr/local/bin/steam"; then
                echo "  Removed SLSsteam wrapper from /usr/local/bin/steam"
            else
                echo -e "  ${YELLOW}Warning: Failed to remove /usr/local/bin/steam${NC}"
            fi
        fi
    fi

    # Clean up steam.sh (remove LD_AUDIT line added by SLSsteam)
    local steam_sh_dir
    if steam_sh_dir=$(find_steam_directory 2>/dev/null) && [[ -f "$steam_sh_dir/steam.sh" ]]; then
        if grep -q "LD_AUDIT.*SLSsteam" "$steam_sh_dir/steam.sh" 2>/dev/null; then
            sed -i '/^export LD_AUDIT.*SLSsteam/d' "$steam_sh_dir/steam.sh"
            echo "  Cleaned LD_AUDIT from $steam_sh_dir/steam.sh"
        fi
    fi
}

echo -e "${GREEN}Starting uninstallation...${NC}"
echo ""

# Uninstall SLSsteam injection first (needs sudo)
uninstall_slssteam_injection
echo ""

# Remove steam.cfg (created by SLSsteam to block updates)
steam_cfg_dir=$(find_steam_directory 2>/dev/null || true)
if [[ -n "$steam_cfg_dir" ]] && [[ -f "$steam_cfg_dir/steam.cfg" ]]; then
    rm -f "$steam_cfg_dir/steam.cfg"
    echo "Removed steam.cfg"
fi

# Remove ACCELA
ACCELA_DIR="$HOME/.local/share/ACCELA"
if [ -d "$ACCELA_DIR" ]; then
	rm -rf "$ACCELA_DIR"
	if [ ! -d "$ACCELA_DIR" ]; then
		echo "ACCELA removed successfully."
	else
		echo "Error: Failed to remove ACCELA." >&2
	fi
else
	echo "ACCELA directory not found. Skipping..."
fi

# Remove SLSsteam (Share and Config)
SLS_SHARE="$HOME/.local/share/SLSsteam"
SLS_CONFIG="$HOME/.config/SLSsteam"
FLATPAK_SLS_SHARE="$HOME/.var/app/com.valvesoftware.Steam/.local/share/SLSsteam"
FLATPAK_SLS_CONFIG="$HOME/.var/app/com.valvesoftware.Steam/.config/SLSsteam"
FOUND_SLS=0

for dir in "$SLS_SHARE" "$SLS_CONFIG" "$FLATPAK_SLS_SHARE" "$FLATPAK_SLS_CONFIG"; do
	if [ -d "$dir" ]; then
		rm -rf "$dir"
		if [ ! -d "$dir" ]; then
			echo "Removed: $dir"
			FOUND_SLS=1
		else
			echo "Error: Failed to remove $dir" >&2
		fi
	fi
done

if [ $FOUND_SLS -eq 0 ]; then
	echo "No SLSsteam directories found. Skipping..."
fi

echo ""
echo -e "${GREEN}Uninstallation completed. Reboot recommended.${NC}"
