#!/bin/bash
set -euo pipefail

# Colors (disabled if not interactive terminal)
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    NC='\033[0m'
else
    GREEN=''
    RED=''
    NC=''
fi

# This script uninstalls ACCELA and SLSsteam from the user's home directory, providing a clear restart for updates and fixes.

# --- Uninstall SLSsteam Injection ---
uninstall_slssteam_injection() {
    echo "Cleaning up SLSsteam injection..."

    local steam_script="/usr/bin/steam"
    local steam_backup="${steam_script}.bak"
    local desktop_shortcut="$HOME/.local/share/applications/steam.desktop"
    local autostart_file="$HOME/.config/autostart/steam.desktop"

    # Restore original steam script from backup
    if [[ -f "$steam_backup" ]]; then
        sudo cp "$steam_backup" "$steam_script"
        echo "  Restored original: $steam_script"
        # Remove backup after restore
        sudo rm -f "$steam_backup"
    else
        echo "  No backup found at $steam_backup"
        # Try to remove LD_AUDIT lines manually (any path)
        if grep -q "LD_AUDIT" "$steam_script" 2>/dev/null; then
            sudo sed -i '/^export LD_AUDIT/d' "$steam_script"
            echo "  Removed LD_AUDIT lines from $steam_script"
        fi
    fi

    # Remove desktop shortcut override (system shortcut will be used again)
    if [[ -f "$desktop_shortcut" ]]; then
        rm -f "$desktop_shortcut"
        echo "  Removed desktop shortcut override."
    fi

    # Restore autostart to use system steam
    if [[ -f "$autostart_file" ]]; then
        # Replace any Exec line pointing to steam with system path
        sed -i 's|Exec=[^ ]*steam[^ ]*|Exec=/usr/bin/steam|g' "$autostart_file"
        echo "  Restored autostart entry."
    fi

    # Also clean up any SLSsteam wrapper if it exists
    if [[ -f "/usr/local/bin/steam" ]]; then
        sudo rm -f "/usr/local/bin/steam"
        echo "  Removed SLSsteam wrapper from /usr/local/bin/steam"
    fi
}

echo -e "${GREEN}Starting uninstallation...${NC}"
echo ""

# Uninstall SLSsteam injection first (needs sudo)
uninstall_slssteam_injection
echo ""

# Remove ACCELA
ACCELA_DIR="$HOME/.local/share/ACCELA"
if [ -d "$ACCELA_DIR" ]; then
	rm -rf "$ACCELA_DIR"
	if [ ! -d "$ACCELA_DIR" ]; then
		echo "ACCELA removed successfully."
	else
		echo "Error: Failed to remove ACCELA." >&2
	fi
else
	echo "ACCELA directory not found. Skipping..."
fi

# Remove SLSsteam (Share and Config)
SLS_SHARE="$HOME/.local/share/SLSsteam"
SLS_CONFIG="$HOME/.config/SLSsteam"
FLATPAK_SLS_SHARE="$HOME/.var/app/com.valvesoftware.Steam/.local/share/SLSsteam"
FLATPAK_SLS_CONFIG="$HOME/.var/app/com.valvesoftware.Steam/.config/SLSsteam"
FOUND_SLS=0

for dir in "$SLS_SHARE" "$SLS_CONFIG" "$FLATPAK_SLS_SHARE" "$FLATPAK_SLS_CONFIG"; do
	if [ -d "$dir" ]; then
		rm -rf "$dir"
		if [ ! -d "$dir" ]; then
			echo "Removed: $dir"
			FOUND_SLS=1
		else
			echo "Error: Failed to remove $dir" >&2
		fi
	fi
done

if [ $FOUND_SLS -eq 0 ]; then
	echo "No SLSsteam directories found. Skipping..."
fi

echo ""
echo -e "${GREEN}Uninstallation completed. Reboot recommended.${NC}"
