#!/bin/bash
set -euo pipefail

# ENTER THE WIRED
# "I am here. But where is here? And where is here within here?"

# Colors (disabled if not interactive terminal)
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN=''
    RED=''
    YELLOW=''
    NC=''
fi

echo -e "${GREEN}Scanning environment for installation (Terminal + Python + Pip + SDL2)...${NC}"

if [ ! -f /etc/os-release ]; then
    echo -e "${RED}Error: /etc/os-release not found.${NC}"
    exit 1
fi

source /etc/os-release

# Export os-release variables for subshells
export ID ID_LIKE VARIANT_ID

# ACCELA URL
ACCELA_URL="https://files.catbox.moe/ffb12t.gz"
TEMP_ARCHIVE="accela_source.tar.gz"
INSTALL_DIR="$HOME/accela"

PKG_MANAGER=""
INSTALL_CMD=""
PACKAGE_LIST=""
NEEDS_UPDATE=false
SKIP_DEPS=false

# Legacy variables for backward compatibility
STEAM_DIR="$HOME/.steam/steam"
FLATPAK_STEAM_DIR="$HOME/.var/app/com.valvesoftware.Steam/.steam/steam"
FLATPAK_SLS_INSTALL_DIR="$HOME/.var/app/com.valvesoftware.Steam/.local/share/SLSsteam"
FLATPAK_SLS_CONFIG_DIR="$HOME/.var/app/com.valvesoftware.Steam/.config/SLSsteam"

# Function to find Steam executable (handles native, Flatpak, custom paths)
find_steam_executable() {
    # 1. Use standard Steam path
    if [ -f "/usr/bin/steam" ]; then
        echo "/usr/bin/steam"
        return 0
    fi

    # 2. Check if Flatpak Steam is available
    if command -v flatpak &>/dev/null; then
        if flatpak info com.valvesoftware.Steam &>/dev/null 2>&1; then
            echo "flatpak run com.valvesoftware.Steam"
            return 0
        fi
    fi

    # 3. Check PATH for steam command (fallback)
    if command -v steam &>/dev/null; then
        echo "$(command -v steam)"
        return 0
    fi

    # 4. Check alternative paths
    for path in /usr/local/bin/steam "$HOME/.local/bin/steam"; do
        if [ -f "$path" ] && [ -x "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# Function to find Steam directory (handles native, Flatpak, custom paths)
find_steam_directory() {
    # Common Steam installation paths (in order of preference)
    local steam_paths=(
        "$HOME/.steam/steam"                    # Modern Steam
        "$HOME/.local/share/Steam"              # Traditional location
        "$FLATPAK_STEAM_DIR"                    # Flatpak Steam
        "/opt/steam/steam"                      # Custom /opt
        "/usr/local/steam"                      # Custom /usr/local
    )

    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ] && [ -f "$path/steam.sh" ]; then
            echo "$path"
            return 0
        fi
    done

    # Fallback: check for any directory with steam.sh
    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# Function to detect Steam installation type (legacy, use find_steam_* instead)
get_steam_dir() {
    local dir
    if dir=$(find_steam_directory); then
        echo "$dir"
    else
        echo "$STEAM_DIR"
    fi
}

get_sls_install_dir() {
    if find_steam_directory &>/dev/null; then
        if [ -d "$FLATPAK_STEAM_DIR" ]; then
            echo "$FLATPAK_SLS_INSTALL_DIR"
        else
            echo "$HOME/.local/share/SLSsteam"
        fi
    else
        echo "$HOME/.local/share/SLSsteam"
    fi
}

get_sls_config_dir() {
    if find_steam_directory &>/dev/null; then
        if [ -d "$FLATPAK_STEAM_DIR" ]; then
            echo "$FLATPAK_SLS_CONFIG_DIR"
        else
            echo "$HOME/.config/SLSsteam"
        fi
    else
        echo "$HOME/.config/SLSsteam"
    fi
}

# Function to run Steam with SLSsteam injection
run_steam_with_sls() {
    local sls_dir
    sls_dir=$(get_sls_install_dir)
    local steam_exe

    if ! steam_exe=$(find_steam_executable); then
        echo "  Warning: Steam executable not found, cannot run Steam"
        return 1
    fi

    local ld_audit=""
    while IFS= read -r so_file; do
        if [ -n "$so_file" ]; then
            if [ -z "$ld_audit" ]; then
                ld_audit="$so_file"
            else
                ld_audit="$ld_audit:$so_file"
            fi
        fi
    done < <(find "$sls_dir" -maxdepth 1 -name "*.so" 2>/dev/null | sort)

    if [ -n "$ld_audit" ]; then
        LD_AUDIT="$ld_audit" $steam_exe "$@"
    else
        echo "  Warning: No SLSsteam .so files found, running Steam without injection" >&2
        $steam_exe "$@"
    fi
}

# Function to patch steam.sh with LD_AUDIT
patch_steam_sh() {
    local steam_dir
    steam_dir=$(get_steam_dir)
    local sls_dir
    sls_dir=$(get_sls_install_dir)
    local steam_sh="$steam_dir/steam.sh"

    if [ ! -f "$steam_sh" ]; then
        echo "  steam.sh not found at $steam_sh"
        return 1
    fi

    # Build LD_AUDIT string
    local ld_audit=""
    while IFS= read -r so_file; do
        if [ -n "$so_file" ]; then
            if [ -z "$ld_audit" ]; then
                ld_audit="$so_file"
            else
                ld_audit="$ld_audit:$so_file"
            fi
        fi
    done < <(find "$sls_dir" -maxdepth 1 -name "*.so" 2>/dev/null | sort)

    # Check if already patched (use simpler grep pattern)
    if grep -q "LD_AUDIT.*SLSsteam" "$steam_sh" 2>/dev/null; then
        echo "  steam.sh already patched, updating..."
        sed -i '/^export LD_AUDIT.*SLSsteam/d' "$steam_sh"
    fi

    # Add LD_AUDIT export at line 10 (same approach as headcrab.sh)
    sed -i '10a export LD_AUDIT="'"$ld_audit"'"' "$steam_sh"
    echo "  Patched steam.sh at $steam_sh"
}

# Function to finalize Steam after installation
finalize_steam() {
    local steam_dir
    steam_dir=$(get_steam_dir)
    local steam_cfg="$steam_dir/steam.cfg"

    echo "Finalizing Steam configuration..."

    # Remove steam.cfg to allow updates
    if [ -f "$steam_cfg" ]; then
        rm -f "$steam_cfg"
        echo "  Removed steam.cfg"
    fi

    # Kill Steam if running (check for both native and flatpak)
    local steam_pids
    steam_pids=$(pgrep -x "steam" 2>/dev/null || true)
    if [ -z "$steam_pids" ] && [ -d "$FLATPAK_STEAM_DIR" ]; then
        steam_pids=$(pgrep -f "com.valvesoftware.Steam" 2>/dev/null || true)
    fi

    if [ -n "$steam_pids" ]; then
        echo "  Closing Steam..."
        echo "$steam_pids" | xargs kill 2>/dev/null || true
        sleep 2
    fi

    # Run Steam with SLSsteam (allows Steam to update if needed)
    echo "  Starting Steam (will auto-update if needed)..."
    run_steam_with_sls &
    RUN_STEAM_PID=$!

    # Wait for Steam to open
    sleep 5

    # Wait for Steam to fully start (check both native and flatpak)
    local attempts=0
    while [ $attempts -lt 12 ]; do
        steam_pids=$(pgrep -x "steam" 2>/dev/null || true)
        if [ -z "$steam_pids" ] && [ -d "$FLATPAK_STEAM_DIR" ]; then
            steam_pids=$(pgrep -f "com.valvesoftware.Steam" 2>/dev/null || true)
        fi
        if [ -n "$steam_pids" ]; then
            break
        fi
        sleep 1
        attempts=$((attempts + 1))
    done

    # Give Steam time to update
    sleep 30

    # Force close Steam
    steam_pids=$(pgrep -x "steam" 2>/dev/null || true)
    if [ -z "$steam_pids" ] && [ -d "$FLATPAK_STEAM_DIR" ]; then
        steam_pids=$(pgrep -f "com.valvesoftware.Steam" 2>/dev/null || true)
    fi

    if [ -n "$steam_pids" ]; then
        echo "  Closing Steam..."
        echo "$steam_pids" | xargs kill 2>/dev/null || true
        sleep 2
    fi

    # Also kill the background run we started
    kill $RUN_STEAM_PID 2>/dev/null || true

    # Create steam.cfg to block future updates
    cat > "$steam_cfg" << 'EOF'
BootStrapperInhibitAll=enable
BootStrapperForceSelfUpdate=disable
EOF
    echo "  Created steam.cfg"
    echo "Status: Patched"
}

# Function to detect distribution family
detect_distro_family() {
    # Priority: direct ID > ID_LIKE > specific files
    # Use default empty string if ID_LIKE is not set
    ID_LIKE="${ID_LIKE:-}"

    # SteamOS (HoloISO) - based on Arch Linux
    if [[ "$ID" == "steamos" ]] || [[ "$ID_LIKE" =~ "steamos" ]]; then
        echo "arch"
        return 0
    fi

    # Bazzite - based on Fedora Atomic
    if [[ "$ID" == "bazzite" ]]; then
        echo "fedora"
        return 0
    fi

    # Fedora/RHEL/CentOS
    if [[ "$ID" == "fedora" || "$ID" == "rhel" || "$ID" == "centos" || \
          "$ID_LIKE" =~ "fedora" || "$ID_LIKE" =~ "rhel" ]]; then
        echo "fedora"
        return 0
    fi

    # Debian/Ubuntu
    if [[ "$ID" == "debian" || "$ID" == "ubuntu" || \
          "$ID_LIKE" =~ "debian" || "$ID_LIKE" =~ "ubuntu" ]]; then
        echo "debian"
        return 0
    fi

    # Arch Linux (includes derivatives like CachyOS, Manjaro, EndeavourOS)
    if [[ "$ID" == "arch" || "$ID_LIKE" =~ "arch" ]] || \
       [ -f "/etc/arch-release" ]; then
        echo "arch"
        return 0
    fi

    return 1
}

# Detect and configure distribution family
FAMILY=$(detect_distro_family)

if [ -z "$FAMILY" ]; then
    echo -e "${YELLOW}Warning: Could not detect distribution family.${NC}"
    echo "ID=$ID, ID_LIKE=$ID_LIKE"
    echo "Defaulting to debian family (apt). You can override with: FAMILY=debian|arch|fedora $0"
    FAMILY="debian"
fi

# Terminals to check (in order of preference)
LINUX_TERMINALS=("wezterm" "konsole" "gnome-terminal" "ptyxis" "alacritty" "tilix" "xfce4-terminal" "terminator" "mate-terminal" "lxterminal" "xterm" "kitty")

# Function to find installed terminal
find_installed_terminal() {
    for terminal in "${LINUX_TERMINALS[@]}"; do
        if command -v "$terminal" &>/dev/null; then
            echo "$terminal"
            return 0
        fi
    done
    return 1
}

# Function to install Konsole
install_konsole() {
    echo -e "${YELLOW}No terminal found. Installing Konsole...${NC}"
    case "$FAMILY" in
        fedora)
            sudo dnf install -y konsole
            ;;
        debian)
            sudo apt install -y konsole
            ;;
        arch)
            sudo pacman -Sy --noconfirm konsole
            ;;
        *)
            echo -e "${RED}Cannot install Konsole automatically on this distribution.${NC}"
            return 1
            ;;
    esac
}

# Check for installed terminal
INSTALLED_TERMINAL=$(find_installed_terminal)
if [ -n "$INSTALLED_TERMINAL" ]; then
    echo "Found terminal: $INSTALLED_TERMINAL"
else
    install_konsole
    if command -v konsole &>/dev/null; then
        echo "Konsole installed successfully."
    fi
fi

case "$FAMILY" in
    fedora)
        echo "Detected system: Fedora family"
        PKG_MANAGER="dnf"
        INSTALL_CMD="sudo dnf install -y"
        PACKAGE_LIST="python3 python3-pip python3-devel SDL2-devel gcc SDL2_mixer-devel SDL2_image-devel SDL2_ttf-devel git libnotify-devel p7zip p7zip-plugins"

        # Check for rpm-ostree (Fedora Atomic/Silverblue/Kinoite/Bazzite)
        if command -v rpm-ostree &>/dev/null && rpm-ostree status &>/dev/null 2>&1; then
            echo -e "${YELLOW}Warning: Immutable Fedora detected (rpm-ostree)${NC}"
            echo ""
            echo "This system uses an immutable file system. Choose an option below:"
            echo ""
            echo "  Option 1: Install via rpm-ostree (requires reboot)"
            echo "    rpm-ostree install python3 python3-pip SDL2-devel gcc SDL2_mixer-devel"
            echo "    Then reboot your system."
            echo ""
            echo "  Option 2: Use Distrobox (no reboot needed)"
            echo "    # Create a Fedora container:"
            echo "    distrobox-create --image fedora:40 --name fedora-dev"
            echo "    distrobox-enter fedora-dev"
            echo "    sudo dnf install -y python3 python3-pip SDL2-devel gcc"
            echo ""
            echo "  Option 3: Use Homebrew (Bazzite default)"
            echo "    brew install python3 sdl2"
            echo ""
            echo "For more info: https://docs.bazzite.gg/Installing_and_Managing_Software/"
            echo ""
            SKIP_DEPS=true
        fi
        ;;
    debian)
        echo "Detected system: Debian/Ubuntu family"
        PKG_MANAGER="apt"
        INSTALL_CMD="sudo apt install -y"
        NEEDS_UPDATE=true
        PACKAGE_LIST="python3 python3-pip python3-dev python3-venv libsdl2-dev build-essential libsdl2-mixer-dev libsdl2-image-dev libsdl2-ttf-dev libxcb-cursor0 libcurl4-openssl-dev git libnotify-bin p7zip-full libcurl4:i386 libssl3:i386 libcrypto++6:i386"
        ;;
    arch)
        # Detect if running on Steam Deck hardware
        if [[ "$ID" == "steamos" ]] || [[ "${VARIANT_ID:-}" == "steamdeck" ]]; then
            echo "Detected system: SteamOS (Arch-based)"
        else
            echo "Detected system: Arch Linux family"
        fi
        PKG_MANAGER="pacman"
        INSTALL_CMD="sudo pacman -Sy --noconfirm"
        PACKAGE_LIST="python python-pip sdl2 gcc sdl2_image sdl2_ttf libxcb curl git libnotify 7zip"

        # Check if multilib repo is enabled (required for 32-bit Steam/SLSsteam)
        if ! grep -q "^\[multilib\]" /etc/pacman.conf; then
            echo -e "${YELLOW}Warning: multilib repository is not enabled in /etc/pacman.conf${NC}"
            echo "Enable it by uncommenting the [multilib] section for 32-bit Steam support."
            echo "After enabling, run: sudo pacman -Sy"
        fi
        ;;
    *)
        echo -e "${RED}Distribution '$NAME' not automatically supported.${NC}"
        echo ""
        echo "Please install dependencies manually:"
        echo "  - Python 3.x with pip"
        echo "  - SDL2 (libsdl2-dev)"
        echo "  - SDL2 Mixer (libsdl2-mixer-dev)"
        echo "  - SDL2 Image (libsdl2-image-dev)"
        echo "  - SDL2 TTF (libsdl2-ttf-dev)"
        echo "  - libnotify (desktop notification library)"
        echo "  - GCC/G++"
        exit 1
        ;;
esac

# Execution
echo -e "Package manager: ${GREEN}$PKG_MANAGER${NC}"
echo -e "Packages to install: ${GREEN}$PACKAGE_LIST${NC}"

# Extra step for Debian/Ubuntu
if [ "$NEEDS_UPDATE" = true ]; then
    echo "Enabling 32-bit (i386) architecture..."
    sudo dpkg --add-architecture i386
    echo "Updating repository lists..."
    sudo apt update
fi

# Install packages in bulk (faster than one-by-one)
if [ "$SKIP_DEPS" = true ]; then
    echo "Skipping system dependency installation (Atomic system detected)."
else
    echo "Installing dependencies..."
    case "$FAMILY" in
        fedora)
            sudo dnf install -y --setopt=install_weak_deps=False $PACKAGE_LIST 2>/dev/null || true
            ;;
        debian)
            sudo apt-get install -y -m $PACKAGE_LIST 2>/dev/null || true
            ;;
        arch)
            sudo pacman -Sy --noconfirm $PACKAGE_LIST 2>/dev/null || true
            ;;
    esac
fi

# Install .NET SDK 9.0
echo -e "${GREEN}Installing .NET SDK 9.0...${NC}"
if ! curl -sSL https://dot.net/v1/dotnet-install.sh | bash -s -- --channel 9.0 --runtime dotnet 2>&1; then
    echo -e "${YELLOW}Warning: .NET SDK installation failed. Continuing anyway...${NC}"
fi

# Add .NET to PATH for current session
export PATH="$HOME/.dotnet:$PATH"

echo -e "${GREEN}Installing ACCELA...${NC}"

# Cleanup to avoid conflicts with previous installation attempts
rm -rf ACCELA-*-linux-source "$TEMP_ARCHIVE"


# Procurar por ACCELA*.tar.gz no diretÃ³rio atual
LOCAL_ARCHIVE=$(find . -maxdepth 1 -name "ACCELA*.tar.gz" -type f 2>/dev/null | head -1)

if [ -n "$LOCAL_ARCHIVE" ]; then
    echo "Found local archive: $LOCAL_ARCHIVE"
    TEMP_ARCHIVE="$LOCAL_ARCHIVE"
else
    echo "Downloading ACCELA..."
    if ! curl -L -o "$TEMP_ARCHIVE" "$ACCELA_URL"; then
        echo -e "${RED}Download error. Check URL or connection.${NC}"
        rm -f "$TEMP_ARCHIVE" 2>/dev/null
        exit 1
    fi
fi

# Verify download was successful (minimum 1KB)
if [ ! -f "$TEMP_ARCHIVE" ]; then
    echo -e "${RED}Error: Download failed or file is empty.${NC}"
    rm -f "$TEMP_ARCHIVE" 2>/dev/null
    exit 1
fi

# Get file size with portable stat syntax
FILE_SIZE=$(stat -c%s "$TEMP_ARCHIVE" 2>/dev/null || stat -f%z "$TEMP_ARCHIVE" 2>/dev/null || echo 0)
if [ "$FILE_SIZE" -lt 1024 ]; then
    echo -e "${RED}Error: Downloaded file is too small (corrupted).${NC}"
    rm -f "$TEMP_ARCHIVE" 2>/dev/null
    exit 1
fi

mkdir -p "$INSTALL_DIR"

echo "Extracting archive..."
if ! tar -xzf "$TEMP_ARCHIVE" -C "$INSTALL_DIR"; then
    echo -e "${RED}Error extracting archive. Download may be corrupted.${NC}"
    rm -f "$TEMP_ARCHIVE" 2>/dev/null
    exit 1
fi
rm "$TEMP_ARCHIVE"

if ! cd "$INSTALL_DIR"; then
    echo -e "${RED}Error: Could not access $INSTALL_DIR${NC}"
    exit 1
fi

echo "Making installer executable..."
if [ -f "./ACCELAINSTALL" ]; then
    chmod +x ./ACCELAINSTALL

    echo -e "${GREEN}Running ACCELAINSTALL...${NC}"
    export SKIPVENV="${SKIPVENV:-0}"
    if ! ./ACCELAINSTALL; then
        echo -e "${RED}Error running ACCELAINSTALL.${NC}"
        exit 1
    fi
else
    echo -e "${RED}Error: 'ACCELAINSTALL' not found in extracted folder.${NC}"
    ls -la
    exit 1
fi


# Install required libraries for ACCELA
ACCELA_DIR="$HOME/.local/share/ACCELA"

if [ ! -d "$ACCELA_DIR" ]; then
    echo -e "${YELLOW}Warning: ACCELA directory not found at $ACCELA_DIR${NC}"
    echo "Skipping Python dependencies installation."
else
    cd "$ACCELA_DIR"

    if [ ! -d ".venv" ]; then
        echo -e "${YELLOW}Warning: Virtualenv not found.${NC}"
        echo "Skipping Python dependencies installation."
    else
        source ./.venv/bin/activate

        # CC=gcc CXX=g++ override pygame's requirement for "gcc-12"
        echo "Installing Python dependencies..."
        if ! CC=gcc CXX=g++ pip install --no-cache-dir --force-reinstall -r "$ACCELA_DIR/requirements.txt" 2>&1; then
            echo -e "${YELLOW}Warning: Some Python dependencies could not be installed.${NC}"
            echo "Continuing anyway..."
        fi
    fi
fi

echo -e "${GREEN}Dependencies installed successfully!${NC}"

# Clean up installer directory only if everything succeeded
echo "Cleaning up temporary files..."
rm -rf "$INSTALL_DIR"

# ============================================================
# SLSSTEAM INSTALLATION FUNCTION
# ============================================================

install_slssteam() {
    echo -e "${GREEN}Installing SLSsteam...${NC}"

    # Variables - use dynamic directories
    SLSSTEAM_INSTALL_DIR=$(get_sls_install_dir)
    SLSSTEAM_CONFIG_DIR=$(get_sls_config_dir)
    STEAM_DIR=$(get_steam_dir)
    STEAM_LIB_DIR="$STEAM_DIR/ubuntu12_32"
    TEMP_SLS="/tmp/slssteam.7z"

    # Remove old libcurl symlink if exists
    if [ -d "$STEAM_LIB_DIR" ]; then
        rm -f "$STEAM_LIB_DIR/libcurl.so"*
        echo "Old libcurl symlinks removed."
    fi

    # Check if 7z is installed, try unzip as fallback
    EXTRACT_CMD=""
    EXTRACT_TYPE=""
    if command -v 7z >/dev/null 2>&1 || command -v 7za >/dev/null 2>&1; then
        EXTRACT_CMD="7z x"
        EXTRACT_TYPE="7z"
    elif command -v unzip >/dev/null 2>&1; then
        echo -e "${YELLOW}Warning: 7z not found, using unzip as fallback${NC}"
        EXTRACT_CMD="unzip -AA"
        EXTRACT_TYPE="unzip"
    else
        if [ "$SKIP_DEPS" = true ]; then
            echo -e "${YELLOW}Warning: Neither 7z nor unzip found${NC}"
            echo "SLSsteam installation will be skipped. Install p7zip or unzip to continue."
            return 0
        else
            echo "Installing p7zip..."
            if case "$FAMILY" in
                fedora) sudo dnf install -y p7zip p7zip-plugins ;;
                debian) sudo apt install -y p7zip-full ;;
                arch)   sudo pacman -Sy --noconfirm p7zip ;;
            esac; then
                EXTRACT_CMD="7z x"
                EXTRACT_TYPE="7z"
            else
                echo -e "${YELLOW}Warning: Could not install 7z, trying unzip...${NC}"
                if command -v unzip >/dev/null 2>&1; then
                    EXTRACT_CMD="unzip -AA"
                    EXTRACT_TYPE="unzip"
                else
                    echo -e "${YELLOW}Warning: Neither 7z nor unzip available${NC}"
                    echo "SLSsteam installation will be skipped."
                    return 0
                fi
            fi
        fi
    fi

    # Check if wget is installed, try curl as fallback
    DOWNLOAD_CMD=""
    if command -v wget >/dev/null 2>&1; then
        DOWNLOAD_CMD="wget -q -O"
    elif command -v curl >/dev/null 2>&1; then
        echo -e "${YELLOW}Warning: wget not found, using curl as fallback${NC}"
        DOWNLOAD_CMD="curl -sL -o"
    else
        if [ "$SKIP_DEPS" = true ]; then
            echo -e "${YELLOW}Warning: Neither wget nor curl found${NC}"
            echo "SLSsteam installation will be skipped."
            return 0
        else
            echo "Installing wget..."
            if case "$FAMILY" in
                fedora) sudo dnf install -y wget ;;
                debian) sudo apt install -y wget ;;
                arch)   sudo pacman -Sy --noconfirm wget ;;
            esac; then
                DOWNLOAD_CMD="wget -q -O"
            else
                echo -e "${YELLOW}Warning: Could not install wget, trying curl...${NC}"
                if command -v curl >/dev/null 2>&1; then
                    DOWNLOAD_CMD="curl -sL -o"
                else
                    echo -e "${YELLOW}Warning: Neither wget nor curl available${NC}"
                    echo "SLSsteam installation will be skipped."
                    return 0
                fi
            fi
        fi
    fi

    # Check if Steam is installed (warning only, don't fail)
    if ! STEAM_DIR=$(find_steam_directory); then
        echo -e "${YELLOW}Warning: Steam directory not found${NC}"
        echo "SLSsteam installation will be skipped. ACCELA will still work."
        echo "Install Steam and re-run this script to enable SLSsteam."
        return 0
    fi

    # Check if Steam is running and warn user
    STEAM_PID=$(pgrep -x "steam" 2>/dev/null || true)
    if [ -n "$STEAM_PID" ]; then
        echo -e "${YELLOW}Steam is running. Please close Steam manually.${NC}"
        if [ -t 0 ]; then
            echo "Press Enter after closing Steam..."
            read -r
            STEAM_PID=$(pgrep -x "steam" 2>/dev/null || true)
            while [ -n "$STEAM_PID" ]; do
                echo "Steam is still running. Please close it."
                sleep 2
                STEAM_PID=$(pgrep -x "steam" 2>/dev/null || true)
            done
        else
            echo "Restart Steam after installation completes."
            sleep 3
        fi
    fi

    # Create directories
    mkdir -p "$SLSSTEAM_INSTALL_DIR"
    mkdir -p "$SLSSTEAM_CONFIG_DIR"

    # Backup existing config
    if [ -f "$SLSSTEAM_CONFIG_DIR/config.yaml" ]; then
        cp "$SLSSTEAM_CONFIG_DIR/config.yaml" "$SLSSTEAM_CONFIG_DIR/config.yaml.bak"
        echo "Config backup created."
    fi

    echo "Downloading SLSsteam..."
    # Get release data from GitHub API
    RELEASE_JSON=$(curl -s "https://api.github.com/repos/AceSLS/SLSsteam/releases/latest")

    if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | grep -q '"message":'; then
        echo -e "${RED}Error fetching SLSsteam release info.${NC}"
        return 1
    fi

    # Extract download URL using grep with more specific pattern
    LATEST_URL=$(echo "$RELEASE_JSON" | grep -o '"browser_download_url": *"[^"]*SLSsteam-Any\.7z"' | \
                 sed 's/"browser_download_url": *"\([^"]*\)"/\1/' | head -1)

    if [ -z "$LATEST_URL" ]; then
        echo -e "${RED}Error: Could not find SLSsteam-Any.7z in release assets.${NC}"
        return 1
    fi

    if ! $DOWNLOAD_CMD "$TEMP_SLS" "$LATEST_URL"; then
        echo -e "${RED}Error downloading SLSsteam.${NC}"
        rm -f "$TEMP_SLS"
        return 1
    fi

    # Extract and install
    echo "Extracting SLSsteam..."
    rm -rf /tmp/slssteam_extract
    mkdir -p /tmp/slssteam_extract

    if ! $EXTRACT_CMD "$TEMP_SLS" -o/tmp/slssteam_extract -y 2>&1 | tail -5; then
        echo -e "${RED}Error extracting archive.${NC}"
        rm -rf /tmp/slssteam_extract "$TEMP_SLS"
        return 1
    fi

    # Find SLSsteam.so in any subdirectory
    SLSSTEAM_SO=$(find /tmp/slssteam_extract -name "SLSsteam.so" -type f 2>/dev/null | head -1)

    if [ -z "$SLSSTEAM_SO" ]; then
        echo -e "${RED}Error: SLSsteam.so not found in archive.${NC}"
        echo "Archive contents:"
        find /tmp/slssteam_extract -type f 2>/dev/null | head -20
        rm -rf /tmp/slssteam_extract "$TEMP_SLS"
        return 1
    fi

    echo "Found SLSsteam.so at: $SLSSTEAM_SO"

    # Configure SLSsteam: ensure PlayNotOwnedGames is enabled (before cleanup)
    mkdir -p "$SLSSTEAM_CONFIG_DIR"
    if [ ! -f "$SLSSTEAM_CONFIG_DIR/config.yaml" ]; then
        if [ -f "/tmp/slssteam_extract/res/config.yaml" ]; then
            cp /tmp/slssteam_extract/res/config.yaml "$SLSSTEAM_CONFIG_DIR/config.yaml"
        fi
    fi

    if grep -q "^PlayNotOwnedGames:" "$SLSSTEAM_CONFIG_DIR/config.yaml" 2>/dev/null; then
        sed -i 's/^PlayNotOwnedGames:.*/PlayNotOwnedGames: yes/' "$SLSSTEAM_CONFIG_DIR/config.yaml"
        echo "PlayNotOwnedGames enabled in config."
    else
        echo "PlayNotOwnedGames: yes" >> "$SLSSTEAM_CONFIG_DIR/config.yaml"
        echo "PlayNotOwnedGames added to config."
    fi

    # Run SLSsteam setup.sh install (handles wrappers, desktop files, etc.)
    cd /tmp/slssteam_extract
    if [ -f "setup.sh" ]; then
        ./setup.sh install
    else
        echo "setup.sh not found, falling back to manual install..."
        # Fallback: manual install
        cp "$SLSSTEAM_SO" "$SLSSTEAM_INSTALL_DIR/"
    fi

    rm -rf /tmp/slssteam_extract "$TEMP_SLS"

    echo "Just open Steam normally to play."
}

# Function to detect Steam Deck (SteamOS)
is_steam_deck() {
    # SteamOS has ID=steamos and VARIANT_ID=steamdeck
    # $ID and $VARIANT_ID are already set from sourcing /etc/os-release at the top
    if [[ "$ID" == "steamos" ]] || [[ "${VARIANT_ID:-}" == "steamdeck" ]]; then
        return 0
    fi

    return 1
}

configure_slssteam_injection() {
    local sls_dir
    sls_dir=$(get_sls_install_dir)
    local steam_script
    local ld_audit

    # Check if SLSsteam is installed
    if [[ ! -d "$sls_dir" ]]; then
        echo "Warn: SLSsteam directory not found"
        return 1
    fi

    # Check if Steam executable is available (warning only)
    if ! steam_script=$(find_steam_executable 2>/dev/null); then
        echo -e "${YELLOW}Warning: Steam executable not found${NC}"
        echo "SLSsteam injection will be skipped. Re-run after installing Steam."
        return 0
    fi

    # Build LD_AUDIT string from .so files
    local so_files
    so_files=$(find "$sls_dir" -maxdepth 1 -name "*.so" | sort)
    if [[ -z "$so_files" ]]; then
        echo "Warn: No .so files found in $sls_dir"
        return 1
    fi

    ld_audit=""
    while IFS= read -r so_file; do
        if [[ -z "$ld_audit" ]]; then
            ld_audit="$so_file"
        else
            ld_audit="$ld_audit:$so_file"
        fi
        echo "  Found: $so_file"
    done <<< "$so_files"

    echo "Configuring SLSsteam injection in $steam_script..."

    # Backup original steam script
    if [[ ! -f "${steam_script}.bak" ]]; then
        sudo cp "$steam_script" "${steam_script}.bak"
        echo "  Backup created: ${steam_script}.bak"
    fi

    # Check if already modified (SLSsteam injection present)
    if grep -q "LD_AUDIT.*SLSsteam" "$steam_script" 2>/dev/null; then
        echo "  SLSsteam injection already present. Updating..."
        # Remove existing LD_AUDIT lines
        sudo sed -i '/^export LD_AUDIT.*SLSsteam/d' "$steam_script"
    fi

    # Find the last exec line and add LD_AUDIT before it
    # This modifies the original /usr/bin/steam
    sudo sed -i '/^exec.*steam.*"\$\@"/i export LD_AUDIT="'"$ld_audit"'"' "$steam_script"

    # Note: Desktop shortcuts are already patched by SLSsteam's setup.sh install

    # Enable PlayNotOwnedGames in config
    local config_file
    config_file=$(get_sls_config_dir)/config.yaml
    if [[ -f "$config_file" ]]; then
        if grep -q "^PlayNotOwnedGames:" "$config_file"; then
            sed -i 's/^PlayNotOwnedGames:.*/PlayNotOwnedGames: yes/' "$config_file"
            echo "  PlayNotOwnedGames enabled"
        fi
    fi

    # Enable SafeMode ONLY on Steam Deck
    if is_steam_deck; then
        echo "  Steam Deck detected - enabling SafeMode"
        if grep -q "^SafeMode:" "$config_file" 2>/dev/null; then
            sed -i 's/^SafeMode:.*/SafeMode: yes/' "$config_file"
        else
            echo "SafeMode: yes" >> "$config_file"
        fi
        echo "  SafeMode enabled"
    else
        echo "  Non-Steam Deck system - SafeMode not enabled"
    fi

    echo "SLSsteam injection configured successfully."
}

# Function to get LD_AUDIT string from SLSsteam files
get_ld_audit() {
    local sls_dir
    sls_dir=$(get_sls_install_dir)
    local ld_audit=""

    while IFS= read -r so_file; do
        if [ -n "$so_file" ]; then
            if [ -z "$ld_audit" ]; then
                ld_audit="$so_file"
            else
                ld_audit="$ld_audit:$so_file"
            fi
        fi
    done < <(find "$sls_dir" -maxdepth 1 -name "*.so" 2>/dev/null | sort)

    echo "$ld_audit"
}

echo -e "${GREEN}Installing SLSsteam...${NC}"
install_slssteam

# First: open Steam without steam.cfg so it can update
echo -e "${GREEN}Finalizing Steam configuration...${NC}"
finalize_steam

# Then: patch Steam scripts (after Steam closes)
echo -e "${GREEN}Patching Steam scripts...${NC}"
configure_slssteam_injection
patch_steam_sh

echo ""
echo "=============================================="
echo -e "${GREEN}  ALL INSTALLATIONS COMPLETED!${NC}"
echo "=============================================="
echo ""
echo "  ACCELA:  Installed at ~/.local/share/ACCELA"
echo "  SLSsteam: Installed at $(get_sls_install_dir)"
echo ""

# Steam Deck specific message
if is_steam_deck; then
    echo -e "${YELLOW}  Steam Deck detected!${NC}"
    echo ""
    echo "  - Use Game Mode to launch ACCELA"
    echo "  - SLSsteam SafeMode is enabled for stability"
    echo "  - Some desktop features may require Konsole installation"
else
    echo "  Launch ACCELA from your applications menu."
fi

# Bazzite specific message
if [[ "$ID" == "bazzite" ]]; then
    echo ""
    echo -e "${YELLOW}  Bazzite detected!${NC}"
    echo ""
    echo "  - ACCELA should appear in your app launcher"
    echo "  - For desktop mode, use the Applications menu"
    echo "  - Steam Deck plugins (Decky Loader) are pre-installed"
fi

echo ""
echo "  To play with SLSsteam, just restart Steam."
echo ""
echo "Protocol complete. Welcome to the Wired."
