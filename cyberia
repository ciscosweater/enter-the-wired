#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-.}")" && pwd)"
VENV_BASE="$HOME/.local/share/millennium/.venv"
VENV_ACTIVATE="$VENV_BASE/bin/activate"
PLUGINS_DIR="$HOME/.local/share/millennium/plugins"

check_millennium() {
    [ -d "$HOME/.local/share/millennium" ]
}

install_millennium() {
    echo "Installing Millennium..."
    curl -fsSL https://raw.githubusercontent.com/SteamClientHomebrew/Millennium/main/scripts/install.sh | bash
}

get_latest_release() {
    curl -sL "https://api.github.com/repos/ciscosweater/cyberia/releases/latest" | jq -r '.tag_name'
}

install_cyberia(){
    local latest_tag version zip_path plugin_dir

    # Check if Millennium is installed
    if ! check_millennium; then
        echo "Millennium not found. Installing..."
        install_millennium
    else
        echo "Millennium already installed."
    fi

    # Create venv if it doesn't exist
    if [ ! -f "$VENV_ACTIVATE" ]; then
        echo "Creating Python virtual environment..."
        python3 -m venv "$VENV_BASE"
    fi

    latest_tag=$(get_latest_release)
    version="${latest_tag#v}"
    zip_path="$SCRIPT_DIR/cyberia-v${version}.zip"
    plugin_dir="$PLUGINS_DIR/cyberia"

    echo "Downloading Cyberia ${latest_tag}..."
    if ! wget -q --show-progress "https://github.com/ciscosweater/cyberia/releases/download/${latest_tag}/cyberia-v${version}.zip" -O "$zip_path"; then
        echo "Failed to download Cyberia."
        exit 1
    fi

    echo "Extracting..."
    rm -rf "$PLUGINS_DIR"/cyberia-v*
    unzip -o -q "$zip_path" -d "$plugin_dir"

    echo "Installing dependencies..."
    source "$VENV_ACTIVATE"
    pip install --quiet --disable-pip-version-check -r "$plugin_dir/requirements.txt"

    rm "$zip_path"
    echo "Cyberia installed successfully!"
    echo ""
    echo "To enable: Steam > Millennium > Settings > Plugins > Enable Cyberia > Save & Reload"
    steam steam://millennium/settings/plugins &> /dev/null &
}

install_cyberia
